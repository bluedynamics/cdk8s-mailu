<!DOCTYPE html>
<html lang="en" data-accent-color="cyan" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Backup and Restore - cdk8s-mailu</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Reference" href="../reference/index.html" /><link rel="prev" title="Upgrade Mailu Version" href="upgrade-mailu.html" />
      <link rel="canonical" href="https://bluedynamics.github.io/cdk8s-mailu/how-to/backup-restore.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"dark");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=14737038" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/brand-theme.css?v=e545c45d" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://bluedynamics.github.io/cdk8s-mailu/how-to/backup-restore.html"/>
  <meta property="og:title" content="Backup and Restore"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../_static/mailu-logo.svg" alt="cdk8s-mailu" height="28" loading="lazy" />
      <img class="dark-logo" src="../_static/mailu-logo.svg" alt="cdk8s-mailu" height="28" loading="lazy" />
      <strong>cdk8s-mailu</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/01-quick-start.html">Quick Start: Deploy Your First Mailu Instance</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How-To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup-prerequisites.html">Setup Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="setup-postgresql.html">Setup PostgreSQL Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="setup-redis.html">Setup Redis</a></li>
<li class="toctree-l2"><a class="reference internal" href="configure-construct.html">Configure Constructs</a></li>
<li class="toctree-l2"><a class="reference internal" href="scale-resources.html">Scale Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="customize-storage.html">Customize Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="enable-optional-components.html">Enable Optional Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="configure-tls.html">Configure TLS Termination</a></li>
<li class="toctree-l2"><a class="reference internal" href="manage-secrets.html">Manage Secrets</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-mailu.html">Upgrade Mailu Version</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Backup and Restore</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/configuration-options.html">Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/component-specifications.html">Component Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../explanation/index.html">Explanation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanation/architecture.html">Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/authentication-flows.html">Authentication Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/nginx-configuration-patches.html">Nginx Configuration Patches</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/storage-architecture.html">Storage Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/dovecot-submission.html">Dovecot Submission Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/egress-gateway-considerations.html">Egress Gateway Considerations for Mail Delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../explanation/cdk8s-patterns.html">CDK8S Patterns</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#problem">Problem</a></li>
<li><a class="reference internal" href="#solution">Solution</a></li>
<li><a class="reference internal" href="#what-to-backup">What to Backup</a><ul>
<li><a class="reference internal" href="#critical-data-must-backup">Critical Data (Must Backup)</a></li>
<li><a class="reference internal" href="#optional-data-nice-to-backup">Optional Data (Nice to Backup)</a></li>
<li><a class="reference internal" href="#configuration-version-control">Configuration (Version Control)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-postgresql-database">Backup PostgreSQL Database</a><ul>
<li><a class="reference internal" href="#manual-database-backup">Manual Database Backup</a></li>
<li><a class="reference internal" href="#automated-database-backups">Automated Database Backups</a></li>
<li><a class="reference internal" href="#cloudnativepg-automated-backups">CloudNativePG Automated Backups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-persistentvolumes">Backup PersistentVolumes</a><ul>
<li><a class="reference internal" href="#longhorn-volume-snapshots">Longhorn Volume Snapshots</a><ul>
<li><a class="reference internal" href="#manual-snapshot">Manual Snapshot</a></li>
<li><a class="reference internal" href="#automated-recurring-snapshots">Automated Recurring Snapshots</a></li>
<li><a class="reference internal" href="#longhorn-backup-to-s3">Longhorn Backup to S3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#velero-cluster-backups">Velero Cluster Backups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-kubernetes-secrets">Backup Kubernetes Secrets</a><ul>
<li><a class="reference internal" href="#manual-secret-backup">Manual Secret Backup</a></li>
<li><a class="reference internal" href="#sealed-secrets">Sealed Secrets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restore-procedures">Restore Procedures</a><ul>
<li><a class="reference internal" href="#restore-postgresql-database">Restore PostgreSQL Database</a><ul>
<li><a class="reference internal" href="#full-database-restore">Full Database Restore</a></li>
<li><a class="reference internal" href="#cloudnativepg-point-in-time-recovery">CloudNativePG Point-in-Time Recovery</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restore-persistentvolumes">Restore PersistentVolumes</a><ul>
<li><a class="reference internal" href="#longhorn-volume-restore">Longhorn Volume Restore</a></li>
<li><a class="reference internal" href="#velero-namespace-restore">Velero Namespace Restore</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restore-kubernetes-secrets">Restore Kubernetes Secrets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#disaster-recovery-scenarios">Disaster Recovery Scenarios</a><ul>
<li><a class="reference internal" href="#scenario-1-accidental-email-deletion">Scenario 1: Accidental Email Deletion</a></li>
<li><a class="reference internal" href="#scenario-2-database-corruption">Scenario 2: Database Corruption</a></li>
<li><a class="reference internal" href="#scenario-3-complete-cluster-failure">Scenario 3: Complete Cluster Failure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-verification">Backup Verification</a><ul>
<li><a class="reference internal" href="#monthly-backup-test-procedure">Monthly Backup Test Procedure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-storage-recommendations">Backup Storage Recommendations</a><ul>
<li><a class="reference internal" href="#backup-rule">3-2-1 Backup Rule</a></li>
<li><a class="reference internal" href="#example-backup-architecture">Example Backup Architecture</a></li>
<li><a class="reference internal" href="#retention-policies">Retention Policies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backup-monitoring">Backup Monitoring</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">cdk8s-mailu</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="index.html"><span itemprop="name">How-To Guides</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Backup and Restore</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue dark-code" role="main">
          <section id="backup-and-restore">
<h1>Backup and Restore<a class="headerlink" href="#backup-and-restore" title="Link to this heading">¶</a></h1>
<p><strong>How to protect your Mailu data with backups and recover from failures.</strong></p>
<section id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Link to this heading">¶</a></h2>
<p>You need to protect email data, user accounts, configuration, and DKIM keys from hardware failures, human errors, or disasters. You also need a tested procedure to restore service after data loss.</p>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Link to this heading">¶</a></h2>
<p>Implement a comprehensive backup strategy covering PostgreSQL database, PersistentVolumes (mailboxes), and Kubernetes configuration. Test restore procedures regularly to ensure backups are viable.</p>
</section>
<section id="what-to-backup">
<h2>What to Backup<a class="headerlink" href="#what-to-backup" title="Link to this heading">¶</a></h2>
<section id="critical-data-must-backup">
<h3>Critical Data (Must Backup)<a class="headerlink" href="#critical-data-must-backup" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>Data</p></th>
<th class="head"><p>Backup Method</p></th>
<th class="head"><p>Frequency</p></th>
<th class="head"><p>Priority</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>PostgreSQL</strong></p></td>
<td><p>User accounts, domains, aliases</p></td>
<td><p>pg_dump</p></td>
<td><p>Daily</p></td>
<td><p><strong>Critical</strong></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Dovecot PVC</strong></p></td>
<td><p>User mailboxes (email content)</p></td>
<td><p>Volume snapshots</p></td>
<td><p>Daily</p></td>
<td><p><strong>Critical</strong></p></td>
</tr>
<tr class="row-even"><td><p><strong>Admin PVC</strong></p></td>
<td><p>DKIM keys, config</p></td>
<td><p>Volume snapshots</p></td>
<td><p>Weekly</p></td>
<td><p><strong>High</strong></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Rspamd PVC</strong></p></td>
<td><p>Spam learning data</p></td>
<td><p>Volume snapshots</p></td>
<td><p>Weekly</p></td>
<td><p>Medium</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="optional-data-nice-to-backup">
<h3>Optional Data (Nice to Backup)<a class="headerlink" href="#optional-data-nice-to-backup" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>Data</p></th>
<th class="head"><p>Priority</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Postfix PVC</p></td>
<td><p>Mail queue (temporary)</p></td>
<td><p>Low (self-healing)</p></td>
</tr>
<tr class="row-odd"><td><p>ClamAV PVC</p></td>
<td><p>Virus signatures (re-downloadable)</p></td>
<td><p>Low</p></td>
</tr>
<tr class="row-even"><td><p>Webdav PVC</p></td>
<td><p>Calendars, contacts</p></td>
<td><p>Medium</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="configuration-version-control">
<h3>Configuration (Version Control)<a class="headerlink" href="#configuration-version-control" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>Backup Method</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CDK8S source code</p></td>
<td><p>Git repository</p></td>
</tr>
<tr class="row-odd"><td><p>Generated manifests</p></td>
<td><p>Git repository</p></td>
</tr>
<tr class="row-even"><td><p>Kubernetes secrets</p></td>
<td><p>Encrypted backup or external secret manager</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="backup-postgresql-database">
<h2>Backup PostgreSQL Database<a class="headerlink" href="#backup-postgresql-database" title="Link to this heading">¶</a></h2>
<section id="manual-database-backup">
<h3>Manual Database Backup<a class="headerlink" href="#manual-database-backup" title="Link to this heading">¶</a></h3>
<p>Create a one-time database backup:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Dump entire database</span>
</span><span data-line="2">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>postgres<span class="w"> </span>postgres-1<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span data-line="3"><span class="w">  </span>pg_dump<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-d<span class="w"> </span>mailu<span class="w"> </span>--clean<span class="w"> </span>--if-exists<span class="w"> </span><span class="se">\</span>
</span><span data-line="4"><span class="w">  </span>&gt;<span class="w"> </span>mailu-db-backup-<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d-%H%M%S<span class="k">)</span>.sql
</span><span data-line="5">
</span><span data-line="6"><span class="c1"># Compress for storage</span>
</span><span data-line="7">gzip<span class="w"> </span>mailu-db-backup-*.sql
</span></pre></div>
</div>
<p><strong>Backup size</strong>: Typically 1-10MB for small deployments, scales with user count.</p>
</section>
<section id="automated-database-backups">
<h3>Automated Database Backups<a class="headerlink" href="#automated-database-backups" title="Link to this heading">¶</a></h3>
<p>Create a CronJob for daily database backups:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span>
</span><span data-line="2"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CronJob</span>
</span><span data-line="3"><span class="nt">metadata</span><span class="p">:</span>
</span><span data-line="4"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu-db-backup</span>
</span><span data-line="5"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu</span>
</span><span data-line="6"><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="7"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span><span class="w">  </span><span class="c1"># Daily at 2 AM</span>
</span><span data-line="8"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span>
</span><span data-line="9"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="10"><span class="w">      </span><span class="nt">template</span><span class="p">:</span>
</span><span data-line="11"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="12"><span class="w">          </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu-backup</span>
</span><span data-line="13"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span>
</span><span data-line="14"><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backup</span>
</span><span data-line="15"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15</span>
</span><span data-line="16"><span class="w">            </span><span class="nt">command</span><span class="p">:</span>
</span><span data-line="17"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
</span><span data-line="18"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-c</span>
</span><span data-line="19"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span data-line="20"><span class="w">              </span><span class="no">set -e</span>
</span><span data-line="21"><span class="w">              </span><span class="no">BACKUP_FILE=&quot;/backups/mailu-db-$(date +%Y%m%d-%H%M%S).sql&quot;</span>
</span><span data-line="22"><span class="w">              </span><span class="no">pg_dump -h postgres-rw -U mailu -d mailu --clean --if-exists &gt; &quot;$BACKUP_FILE&quot;</span>
</span><span data-line="23"><span class="w">              </span><span class="no">gzip &quot;$BACKUP_FILE&quot;</span>
</span><span data-line="24"><span class="w">              </span><span class="no">echo &quot;Backup completed: ${BACKUP_FILE}.gz&quot;</span>
</span><span data-line="25">
</span><span data-line="26"><span class="w">              </span><span class="no"># Cleanup backups older than 30 days</span>
</span><span data-line="27"><span class="w">              </span><span class="no">find /backups -name &quot;mailu-db-*.sql.gz&quot; -mtime +30 -delete</span>
</span><span data-line="28"><span class="w">            </span><span class="nt">env</span><span class="p">:</span>
</span><span data-line="29"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PGPASSWORD</span>
</span><span data-line="30"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span>
</span><span data-line="31"><span class="w">                </span><span class="nt">secretKeyRef</span><span class="p">:</span>
</span><span data-line="32"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-app</span>
</span><span data-line="33"><span class="w">                  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
</span><span data-line="34"><span class="w">            </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span data-line="35"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backups</span>
</span><span data-line="36"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/backups</span>
</span><span data-line="37"><span class="w">          </span><span class="nt">volumes</span><span class="p">:</span>
</span><span data-line="38"><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backups</span>
</span><span data-line="39"><span class="w">            </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span data-line="40"><span class="w">              </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu-db-backups</span>
</span><span data-line="41"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OnFailure</span>
</span></pre></div>
</div>
<p><strong>Prerequisites</strong>: Create PVC for backup storage:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span data-line="2"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
</span><span data-line="3"><span class="nt">metadata</span><span class="p">:</span>
</span><span data-line="4"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu-db-backups</span>
</span><span data-line="5"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu</span>
</span><span data-line="6"><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="7"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
</span><span data-line="8"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
</span><span data-line="9"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span data-line="10"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
</span><span data-line="11"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50Gi</span><span class="w">  </span><span class="c1"># Adjust based on retention period</span>
</span><span data-line="12"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">longhorn</span>
</span></pre></div>
</div>
</section>
<section id="cloudnativepg-automated-backups">
<h3>CloudNativePG Automated Backups<a class="headerlink" href="#cloudnativepg-automated-backups" title="Link to this heading">¶</a></h3>
<p>If using CloudNativePG (CNPG), configure S3 backups in the PostgreSQL cluster:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql.cnpg.io/v1</span>
</span><span data-line="2"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cluster</span>
</span><span data-line="3"><span class="nt">metadata</span><span class="p">:</span>
</span><span data-line="4"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
</span><span data-line="5"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
</span><span data-line="6"><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="7"><span class="w">  </span><span class="nt">instances</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span data-line="8"><span class="w">  </span><span class="nt">storage</span><span class="p">:</span>
</span><span data-line="9"><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20Gi</span>
</span><span data-line="10">
</span><span data-line="11"><span class="w">  </span><span class="nt">backup</span><span class="p">:</span>
</span><span data-line="12"><span class="w">    </span><span class="nt">barmanObjectStore</span><span class="p">:</span>
</span><span data-line="13"><span class="w">      </span><span class="nt">destinationPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://backup-bucket/postgres-mailu/</span>
</span><span data-line="14"><span class="w">      </span><span class="nt">s3Credentials</span><span class="p">:</span>
</span><span data-line="15"><span class="w">        </span><span class="nt">accessKeyId</span><span class="p">:</span>
</span><span data-line="16"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3-credentials</span>
</span><span data-line="17"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">access-key</span>
</span><span data-line="18"><span class="w">        </span><span class="nt">secretAccessKey</span><span class="p">:</span>
</span><span data-line="19"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3-credentials</span>
</span><span data-line="20"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret-key</span>
</span><span data-line="21"><span class="w">      </span><span class="nt">wal</span><span class="p">:</span>
</span><span data-line="22"><span class="w">        </span><span class="nt">compression</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gzip</span>
</span><span data-line="23"><span class="w">        </span><span class="nt">maxParallel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span data-line="24"><span class="w">    </span><span class="nt">retentionPolicy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30d&quot;</span>
</span><span data-line="25">
</span><span data-line="26"><span class="w">  </span><span class="c1"># Daily full backup at 2 AM</span>
</span><span data-line="27"><span class="w">  </span><span class="nt">scheduledBackup</span><span class="p">:</span>
</span><span data-line="28"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">daily-backup</span>
</span><span data-line="29"><span class="w">    </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
</span><span data-line="30"><span class="w">    </span><span class="nt">backupOwnerReference</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">self</span>
</span><span data-line="31"><span class="w">    </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">primary</span>
</span></pre></div>
</div>
<p><strong>Advantages</strong>: Point-in-time recovery (PITR), automatic WAL archiving, off-site storage.</p>
</section>
</section>
<section id="backup-persistentvolumes">
<h2>Backup PersistentVolumes<a class="headerlink" href="#backup-persistentvolumes" title="Link to this heading">¶</a></h2>
<section id="longhorn-volume-snapshots">
<h3>Longhorn Volume Snapshots<a class="headerlink" href="#longhorn-volume-snapshots" title="Link to this heading">¶</a></h3>
<p>If using Longhorn storage, create volume snapshots:</p>
<section id="manual-snapshot">
<h4>Manual Snapshot<a class="headerlink" href="#manual-snapshot" title="Link to this heading">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Snapshot Dovecot mailboxes</span>
</span><span data-line="2">kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span data-line="3"><span class="s">apiVersion: longhorn.io/v1beta2</span>
</span><span data-line="4"><span class="s">kind: VolumeSnapshot</span>
</span><span data-line="5"><span class="s">metadata:</span>
</span><span data-line="6"><span class="s">  name: dovecot-snapshot-$(date +%Y%m%d)</span>
</span><span data-line="7"><span class="s">  namespace: longhorn-system</span>
</span><span data-line="8"><span class="s">spec:</span>
</span><span data-line="9"><span class="s">  volume: mailu-dovecot-pvc-xxx  # Get from: kubectl get pv</span>
</span><span data-line="10"><span class="s">EOF</span>
</span><span data-line="11">
</span><span data-line="12"><span class="c1"># List snapshots</span>
</span><span data-line="13">kubectl<span class="w"> </span>get<span class="w"> </span>volumesnapshot<span class="w"> </span>-n<span class="w"> </span>longhorn-system
</span></pre></div>
</div>
</section>
<section id="automated-recurring-snapshots">
<h4>Automated Recurring Snapshots<a class="headerlink" href="#automated-recurring-snapshots" title="Link to this heading">¶</a></h4>
<p>Configure Longhorn RecurringJob for automatic snapshots:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">longhorn.io/v1beta2</span>
</span><span data-line="2"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RecurringJob</span>
</span><span data-line="3"><span class="nt">metadata</span><span class="p">:</span>
</span><span data-line="4"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu-daily-snapshot</span>
</span><span data-line="5"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">longhorn-system</span>
</span><span data-line="6"><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="7"><span class="w">  </span><span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span><span class="w">  </span><span class="c1"># Daily at 3 AM</span>
</span><span data-line="8"><span class="w">  </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;snapshot&quot;</span>
</span><span data-line="9"><span class="w">  </span><span class="nt">retain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span><span class="w">  </span><span class="c1"># Keep 7 daily snapshots</span>
</span><span data-line="10"><span class="w">  </span><span class="nt">concurrency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span data-line="11"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span data-line="12"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mailu</span>
</span></pre></div>
</div>
<p>Apply to Dovecot PVC:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Label PVC for automatic snapshots</span>
</span><span data-line="2">kubectl<span class="w"> </span>label<span class="w"> </span>pvc<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-dovecot-pvc<span class="w"> </span>recurring-job.longhorn.io/mailu-daily-snapshot<span class="o">=</span>enabled
</span></pre></div>
</div>
</section>
<section id="longhorn-backup-to-s3">
<h4>Longhorn Backup to S3<a class="headerlink" href="#longhorn-backup-to-s3" title="Link to this heading">¶</a></h4>
<p>Configure Longhorn backup target for off-site backups:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Set S3 backup target (via Longhorn UI or kubectl)</span>
</span><span data-line="2">kubectl<span class="w"> </span>patch<span class="w"> </span>settings.longhorn.io<span class="w"> </span>-n<span class="w"> </span>longhorn-system<span class="w"> </span>backup-target<span class="w"> </span>--type<span class="o">=</span>merge<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;value&quot;:&quot;s3://backup-bucket@region/&quot;}&#39;</span>
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Create backup from snapshot</span>
</span><span data-line="5">kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span data-line="6"><span class="s">apiVersion: longhorn.io/v1beta2</span>
</span><span data-line="7"><span class="s">kind: Backup</span>
</span><span data-line="8"><span class="s">metadata:</span>
</span><span data-line="9"><span class="s">  name: dovecot-backup-$(date +%Y%m%d)</span>
</span><span data-line="10"><span class="s">  namespace: longhorn-system</span>
</span><span data-line="11"><span class="s">spec:</span>
</span><span data-line="12"><span class="s">  snapshotName: dovecot-snapshot-YYYYMMDD</span>
</span><span data-line="13"><span class="s">  labels:</span>
</span><span data-line="14"><span class="s">    app: mailu</span>
</span><span data-line="15"><span class="s">    component: dovecot</span>
</span><span data-line="16"><span class="s">EOF</span>
</span></pre></div>
</div>
</section>
</section>
<section id="velero-cluster-backups">
<h3>Velero Cluster Backups<a class="headerlink" href="#velero-cluster-backups" title="Link to this heading">¶</a></h3>
<p>For full cluster-level backups, use <a class="reference external" href="https://velero.io/">Velero</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Install Velero with S3 backend</span>
</span><span data-line="2">velero<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
</span><span data-line="3"><span class="w">  </span>--provider<span class="w"> </span>aws<span class="w"> </span><span class="se">\</span>
</span><span data-line="4"><span class="w">  </span>--bucket<span class="w"> </span>mailu-backups<span class="w"> </span><span class="se">\</span>
</span><span data-line="5"><span class="w">  </span>--secret-file<span class="w"> </span>./credentials-velero<span class="w"> </span><span class="se">\</span>
</span><span data-line="6"><span class="w">  </span>--backup-location-config<span class="w"> </span><span class="nv">region</span><span class="o">=</span>us-east-1
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Backup Mailu namespace</span>
</span><span data-line="9">velero<span class="w"> </span>backup<span class="w"> </span>create<span class="w"> </span>mailu-backup-<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="10"><span class="w">  </span>--include-namespaces<span class="w"> </span>mailu<span class="w"> </span><span class="se">\</span>
</span><span data-line="11"><span class="w">  </span>--default-volumes-to-fs-backup
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Schedule daily backups</span>
</span><span data-line="14">velero<span class="w"> </span>schedule<span class="w"> </span>create<span class="w"> </span>mailu-daily<span class="w"> </span><span class="se">\</span>
</span><span data-line="15"><span class="w">  </span>--schedule<span class="o">=</span><span class="s2">&quot;0 2 * * *&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="16"><span class="w">  </span>--include-namespaces<span class="w"> </span>mailu<span class="w"> </span><span class="se">\</span>
</span><span data-line="17"><span class="w">  </span>--default-volumes-to-fs-backup<span class="w"> </span><span class="se">\</span>
</span><span data-line="18"><span class="w">  </span>--ttl<span class="w"> </span>720h<span class="w">  </span><span class="c1"># 30 days retention</span>
</span></pre></div>
</div>
</section>
</section>
<section id="backup-kubernetes-secrets">
<h2>Backup Kubernetes Secrets<a class="headerlink" href="#backup-kubernetes-secrets" title="Link to this heading">¶</a></h2>
<p><strong>Warning</strong>: Secrets contain sensitive data. Encrypt backups and store securely.</p>
<section id="manual-secret-backup">
<h3>Manual Secret Backup<a class="headerlink" href="#manual-secret-backup" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Export all Mailu secrets</span>
</span><span data-line="2">kubectl<span class="w"> </span>get<span class="w"> </span>secrets<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>mailu-secrets-backup-<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span>.yaml
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Encrypt with GPG</span>
</span><span data-line="5">gpg<span class="w"> </span>--symmetric<span class="w"> </span>--cipher-algo<span class="w"> </span>AES256<span class="w"> </span>mailu-secrets-backup-*.yaml
</span><span data-line="6">
</span><span data-line="7"><span class="c1"># Store encrypted file securely (off-site)</span>
</span></pre></div>
</div>
</section>
<section id="sealed-secrets">
<h3>Sealed Secrets<a class="headerlink" href="#sealed-secrets" title="Link to this heading">¶</a></h3>
<p>Use <a class="reference external" href="https://github.com/bitnami-labs/sealed-secrets">Sealed Secrets</a> for safe secret storage in git:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Install Sealed Secrets controller</span>
</span><span data-line="2">kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://github.com/bitnami-labs/sealed-secrets/releases/latest/download/controller.yaml
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Create sealed secret</span>
</span><span data-line="5">kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>mailu-secrets<span class="w"> </span><span class="se">\</span>
</span><span data-line="6"><span class="w">  </span>--from-literal<span class="o">=</span>secret-key<span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="7"><span class="w">  </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="8"><span class="w">  </span>kubeseal<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>sealed-secret-mailu.yaml
</span><span data-line="9">
</span><span data-line="10"><span class="c1"># Commit sealed secret to git (safe - encrypted)</span>
</span><span data-line="11">git<span class="w"> </span>add<span class="w"> </span>sealed-secret-mailu.yaml
</span><span data-line="12">git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add Mailu sealed secret&quot;</span>
</span></pre></div>
</div>
</section>
</section>
<section id="restore-procedures">
<h2>Restore Procedures<a class="headerlink" href="#restore-procedures" title="Link to this heading">¶</a></h2>
<section id="restore-postgresql-database">
<h3>Restore PostgreSQL Database<a class="headerlink" href="#restore-postgresql-database" title="Link to this heading">¶</a></h3>
<section id="full-database-restore">
<h4>Full Database Restore<a class="headerlink" href="#full-database-restore" title="Link to this heading">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Stop Mailu pods to prevent write conflicts</span>
</span><span data-line="2">kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-admin<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span>
</span><span data-line="3">kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-front<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Drop and recreate database (CAUTION: deletes current data)</span>
</span><span data-line="6">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>postgres<span class="w"> </span>postgres-1<span class="w"> </span>--<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;DROP DATABASE mailu;&quot;</span>
</span><span data-line="7">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>postgres<span class="w"> </span>postgres-1<span class="w"> </span>--<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;CREATE DATABASE mailu OWNER mailu;&quot;</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># Restore from backup</span>
</span><span data-line="10">gunzip<span class="w"> </span>&lt;<span class="w"> </span>mailu-db-backup-20250110.sql.gz<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="11"><span class="w">  </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-i<span class="w"> </span>-n<span class="w"> </span>postgres<span class="w"> </span>postgres-1<span class="w"> </span>--<span class="w"> </span>psql<span class="w"> </span>-U<span class="w"> </span>postgres<span class="w"> </span>-d<span class="w"> </span>mailu
</span><span data-line="12">
</span><span data-line="13"><span class="c1"># Restart Mailu pods</span>
</span><span data-line="14">kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-admin<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1</span>
</span><span data-line="15">kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-front<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1</span>
</span></pre></div>
</div>
</section>
<section id="cloudnativepg-point-in-time-recovery">
<h4>CloudNativePG Point-in-Time Recovery<a class="headerlink" href="#cloudnativepg-point-in-time-recovery" title="Link to this heading">¶</a></h4>
<p>Restore CNPG cluster to specific timestamp:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql.cnpg.io/v1</span>
</span><span data-line="2"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cluster</span>
</span><span data-line="3"><span class="nt">metadata</span><span class="p">:</span>
</span><span data-line="4"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-restored</span>
</span><span data-line="5"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
</span><span data-line="6"><span class="nt">spec</span><span class="p">:</span>
</span><span data-line="7"><span class="w">  </span><span class="nt">instances</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span data-line="8">
</span><span data-line="9"><span class="w">  </span><span class="nt">bootstrap</span><span class="p">:</span>
</span><span data-line="10"><span class="w">    </span><span class="nt">recovery</span><span class="p">:</span>
</span><span data-line="11"><span class="w">      </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-backup</span>
</span><span data-line="12"><span class="w">      </span><span class="nt">recoveryTarget</span><span class="p">:</span>
</span><span data-line="13"><span class="w">        </span><span class="nt">targetTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2025-01-10</span><span class="nv"> </span><span class="s">14:00:00&quot;</span><span class="w">  </span><span class="c1"># Restore to this timestamp</span>
</span><span data-line="14">
</span><span data-line="15"><span class="w">  </span><span class="nt">externalClusters</span><span class="p">:</span>
</span><span data-line="16"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-backup</span>
</span><span data-line="17"><span class="w">    </span><span class="nt">barmanObjectStore</span><span class="p">:</span>
</span><span data-line="18"><span class="w">      </span><span class="nt">destinationPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://backup-bucket/postgres-mailu/</span>
</span><span data-line="19"><span class="w">      </span><span class="nt">s3Credentials</span><span class="p">:</span>
</span><span data-line="20"><span class="w">        </span><span class="nt">accessKeyId</span><span class="p">:</span>
</span><span data-line="21"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3-credentials</span>
</span><span data-line="22"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">access-key</span>
</span><span data-line="23"><span class="w">        </span><span class="nt">secretAccessKey</span><span class="p">:</span>
</span><span data-line="24"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3-credentials</span>
</span><span data-line="25"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret-key</span>
</span></pre></div>
</div>
</section>
</section>
<section id="restore-persistentvolumes">
<h3>Restore PersistentVolumes<a class="headerlink" href="#restore-persistentvolumes" title="Link to this heading">¶</a></h3>
<section id="longhorn-volume-restore">
<h4>Longhorn Volume Restore<a class="headerlink" href="#longhorn-volume-restore" title="Link to this heading">¶</a></h4>
<p>Restore from Longhorn snapshot:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Method 1: Restore from snapshot (creates new PVC)</span>
</span><span data-line="2">kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span data-line="3"><span class="s">apiVersion: v1</span>
</span><span data-line="4"><span class="s">kind: PersistentVolumeClaim</span>
</span><span data-line="5"><span class="s">metadata:</span>
</span><span data-line="6"><span class="s">  name: mailu-dovecot-restored</span>
</span><span data-line="7"><span class="s">  namespace: mailu</span>
</span><span data-line="8"><span class="s">spec:</span>
</span><span data-line="9"><span class="s">  dataSource:</span>
</span><span data-line="10"><span class="s">    name: dovecot-snapshot-20250110</span>
</span><span data-line="11"><span class="s">    kind: VolumeSnapshot</span>
</span><span data-line="12"><span class="s">    apiGroup: longhorn.io</span>
</span><span data-line="13"><span class="s">  accessModes:</span>
</span><span data-line="14"><span class="s">    - ReadWriteOnce</span>
</span><span data-line="15"><span class="s">  resources:</span>
</span><span data-line="16"><span class="s">    requests:</span>
</span><span data-line="17"><span class="s">      storage: 200Gi</span>
</span><span data-line="18"><span class="s">  storageClassName: longhorn</span>
</span><span data-line="19"><span class="s">EOF</span>
</span><span data-line="20">
</span><span data-line="21"><span class="c1"># Method 2: Restore from backup (Longhorn UI)</span>
</span><span data-line="22"><span class="c1"># 1. Go to Longhorn UI → Backup</span>
</span><span data-line="23"><span class="c1"># 2. Find backup: dovecot-backup-20250110</span>
</span><span data-line="24"><span class="c1"># 3. Click &quot;Restore&quot; → creates new volume</span>
</span><span data-line="25"><span class="c1"># 4. Create PVC pointing to restored volume</span>
</span></pre></div>
</div>
<p>Update deployment to use restored PVC:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Edit deployment to reference new PVC</span>
</span><span data-line="2">kubectl<span class="w"> </span>edit<span class="w"> </span>deployment<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-dovecot
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Change:</span>
</span><span data-line="5"><span class="c1">#   volumes:</span>
</span><span data-line="6"><span class="c1">#   - name: mail</span>
</span><span data-line="7"><span class="c1">#     persistentVolumeClaim:</span>
</span><span data-line="8"><span class="c1">#       claimName: mailu-dovecot-restored  # Updated</span>
</span></pre></div>
</div>
</section>
<section id="velero-namespace-restore">
<h4>Velero Namespace Restore<a class="headerlink" href="#velero-namespace-restore" title="Link to this heading">¶</a></h4>
<p>Restore entire Mailu namespace from Velero backup:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># List available backups</span>
</span><span data-line="2">velero<span class="w"> </span>backup<span class="w"> </span>get
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Restore from specific backup</span>
</span><span data-line="5">velero<span class="w"> </span>restore<span class="w"> </span>create<span class="w"> </span>mailu-restore-<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="6"><span class="w">  </span>--from-backup<span class="w"> </span>mailu-backup-20250110
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Monitor restore progress</span>
</span><span data-line="9">velero<span class="w"> </span>restore<span class="w"> </span>describe<span class="w"> </span>mailu-restore-YYYYMMDD
</span><span data-line="10">kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>-w
</span></pre></div>
</div>
</section>
</section>
<section id="restore-kubernetes-secrets">
<h3>Restore Kubernetes Secrets<a class="headerlink" href="#restore-kubernetes-secrets" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Decrypt secret backup</span>
</span><span data-line="2">gpg<span class="w"> </span>--decrypt<span class="w"> </span>mailu-secrets-backup-20250110.yaml.gpg<span class="w"> </span>&gt;<span class="w"> </span>secrets.yaml
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Apply secrets</span>
</span><span data-line="5">kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>secrets.yaml
</span><span data-line="6">
</span><span data-line="7"><span class="c1"># Clean up decrypted file</span>
</span><span data-line="8">rm<span class="w"> </span>secrets.yaml
</span></pre></div>
</div>
</section>
</section>
<section id="disaster-recovery-scenarios">
<h2>Disaster Recovery Scenarios<a class="headerlink" href="#disaster-recovery-scenarios" title="Link to this heading">¶</a></h2>
<section id="scenario-1-accidental-email-deletion">
<h3>Scenario 1: Accidental Email Deletion<a class="headerlink" href="#scenario-1-accidental-email-deletion" title="Link to this heading">¶</a></h3>
<p><strong>Symptoms</strong>: User reports missing emails.</p>
<p><strong>Recovery</strong>:</p>
<ol class="arabic simple">
<li><p>Restore Dovecot PVC from most recent snapshot (before deletion)</p></li>
<li><p>Mount restored volume to temporary pod</p></li>
<li><p>Extract deleted user’s mailbox</p></li>
<li><p>Copy mailbox to production Dovecot pod</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Create recovery pod with restored PVC</span>
</span><span data-line="2">kubectl<span class="w"> </span>run<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>dovecot-recovery<span class="w"> </span><span class="se">\</span>
</span><span data-line="3"><span class="w">  </span>--image<span class="o">=</span>alpine<span class="w"> </span>--command<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span>infinity
</span><span data-line="4">kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>volumes<span class="w"> </span>pod/dovecot-recovery<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span><span class="se">\</span>
</span><span data-line="5"><span class="w">  </span>--add<span class="w"> </span>--name<span class="o">=</span>mail-restored<span class="w"> </span><span class="se">\</span>
</span><span data-line="6"><span class="w">  </span>--claim-name<span class="o">=</span>mailu-dovecot-restored
</span><span data-line="7">
</span><span data-line="8"><span class="c1"># Copy mailbox</span>
</span><span data-line="9">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>dovecot-recovery<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span data-line="10"><span class="w">  </span>tar<span class="w"> </span>czf<span class="w"> </span>/tmp/user-mailbox.tar.gz<span class="w"> </span>/mail/user@example.com
</span><span data-line="11">
</span><span data-line="12">kubectl<span class="w"> </span>cp<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>dovecot-recovery:/tmp/user-mailbox.tar.gz<span class="w"> </span>./user-mailbox.tar.gz
</span><span data-line="13">
</span><span data-line="14"><span class="c1"># Extract to production pod</span>
</span><span data-line="15">kubectl<span class="w"> </span>cp<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>./user-mailbox.tar.gz<span class="w"> </span>mailu-dovecot-xxx:/tmp/
</span><span data-line="16">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>mailu-dovecot-xxx<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span data-line="17"><span class="w">  </span>tar<span class="w"> </span>xzf<span class="w"> </span>/tmp/user-mailbox.tar.gz<span class="w"> </span>-C<span class="w"> </span>/
</span></pre></div>
</div>
</section>
<section id="scenario-2-database-corruption">
<h3>Scenario 2: Database Corruption<a class="headerlink" href="#scenario-2-database-corruption" title="Link to this heading">¶</a></h3>
<p><strong>Symptoms</strong>: Admin UI errors, authentication failures.</p>
<p><strong>Recovery</strong>:</p>
<ol class="arabic simple">
<li><p>Stop all Mailu pods</p></li>
<li><p>Restore database from most recent backup</p></li>
<li><p>Restart Mailu pods</p></li>
<li><p>Verify user can login</p></li>
</ol>
<p><em>(See “Restore PostgreSQL Database” section above)</em></p>
</section>
<section id="scenario-3-complete-cluster-failure">
<h3>Scenario 3: Complete Cluster Failure<a class="headerlink" href="#scenario-3-complete-cluster-failure" title="Link to this heading">¶</a></h3>
<p><strong>Symptoms</strong>: Entire cluster lost (hardware failure, cloud provider issue).</p>
<p><strong>Recovery</strong> (assumes Velero backups to external S3):</p>
<ol class="arabic simple">
<li><p>Build new Kubernetes cluster</p></li>
<li><p>Install Velero</p></li>
<li><p>Restore Mailu namespace from backup</p></li>
<li><p>Update DNS to point to new cluster</p></li>
<li><p>Verify email flow</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># On new cluster</span>
</span><span data-line="2">velero<span class="w"> </span>install<span class="w"> </span>--provider<span class="w"> </span>aws<span class="w"> </span>--bucket<span class="w"> </span>mailu-backups<span class="w"> </span>...
</span><span data-line="3">
</span><span data-line="4">velero<span class="w"> </span>restore<span class="w"> </span>create<span class="w"> </span>mailu-disaster-recovery<span class="w"> </span><span class="se">\</span>
</span><span data-line="5"><span class="w">  </span>--from-backup<span class="w"> </span>mailu-backup-20250110
</span><span data-line="6">
</span><span data-line="7">kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>mailu<span class="w"> </span>-w
</span></pre></div>
</div>
</section>
</section>
<section id="backup-verification">
<h2>Backup Verification<a class="headerlink" href="#backup-verification" title="Link to this heading">¶</a></h2>
<p><strong>Critical</strong>: Test backups regularly to ensure they work!</p>
<section id="monthly-backup-test-procedure">
<h3>Monthly Backup Test Procedure<a class="headerlink" href="#monthly-backup-test-procedure" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Restore to test environment</strong>:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Create test namespace</span>
</span><span data-line="2">kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>mailu-test
</span><span data-line="3">
</span><span data-line="4"><span class="c1"># Restore from production backup</span>
</span><span data-line="5">velero<span class="w"> </span>restore<span class="w"> </span>create<span class="w"> </span>mailu-test-restore<span class="w"> </span><span class="se">\</span>
</span><span data-line="6"><span class="w">  </span>--from-backup<span class="w"> </span>mailu-backup-latest<span class="w"> </span><span class="se">\</span>
</span><span data-line="7"><span class="w">  </span>--namespace-mappings<span class="w"> </span>mailu:mailu-test
</span></pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Verify data integrity</strong>:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Check database</span>
</span><span data-line="2">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>mailu-test<span class="w"> </span>mailu-admin-xxx<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span data-line="3"><span class="w">  </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from mailu import db; db.init_app(); print(&#39;DB OK&#39;)&quot;</span>
</span><span data-line="4">
</span><span data-line="5"><span class="c1"># Check mailbox</span>
</span><span data-line="6">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>mailu-test<span class="w"> </span>mailu-dovecot-xxx<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
</span><span data-line="7"><span class="w">  </span>ls<span class="w"> </span>-lh<span class="w"> </span>/mail/
</span></pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>Test functionality</strong>:</p></li>
</ol>
<ul class="simple">
<li><p>Login to admin UI</p></li>
<li><p>Login to webmail</p></li>
<li><p>Send test email</p></li>
<li><p>Receive test email</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>Document results</strong>:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Backup test </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">: PASSED&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>backup-test-log.txt
</span></pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p><strong>Clean up</strong>:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1">kubectl<span class="w"> </span>delete<span class="w"> </span>namespace<span class="w"> </span>mailu-test
</span></pre></div>
</div>
</section>
</section>
<section id="backup-storage-recommendations">
<h2>Backup Storage Recommendations<a class="headerlink" href="#backup-storage-recommendations" title="Link to this heading">¶</a></h2>
<section id="backup-rule">
<h3>3-2-1 Backup Rule<a class="headerlink" href="#backup-rule" title="Link to this heading">¶</a></h3>
<p>Follow the 3-2-1 backup strategy:</p>
<ul class="simple">
<li><p><strong>3 copies</strong> of data (production + 2 backups)</p></li>
<li><p><strong>2 different media types</strong> (local PVC + S3)</p></li>
<li><p><strong>1 off-site copy</strong> (different datacenter/region)</p></li>
</ul>
</section>
<section id="example-backup-architecture">
<h3>Example Backup Architecture<a class="headerlink" href="#example-backup-architecture" title="Link to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1">Production Mailu
</span><span data-line="2">    ↓
</span><span data-line="3">┌─────────────────────────────────────┐
</span><span data-line="4">│ Primary Backups (Same Cluster)     │
</span><span data-line="5">│ - Longhorn snapshots (7 days)      │
</span><span data-line="6">│ - Database dumps on PVC             │
</span><span data-line="7">└─────────────────────────────────────┘
</span><span data-line="8">    ↓
</span><span data-line="9">┌─────────────────────────────────────┐
</span><span data-line="10">│ Secondary Backups (S3, Same Region)│
</span><span data-line="11">│ - Longhorn backups to S3            │
</span><span data-line="12">│ - CNPG WAL archives                 │
</span><span data-line="13">│ - Velero backups (30 days)          │
</span><span data-line="14">└─────────────────────────────────────┘
</span><span data-line="15">    ↓
</span><span data-line="16">┌─────────────────────────────────────┐
</span><span data-line="17">│ Tertiary Backups (S3, Other Region)│
</span><span data-line="18">│ - Cross-region S3 replication       │
</span><span data-line="19">│ - Long-term archives (1 year)       │
</span><span data-line="20">└─────────────────────────────────────┘
</span></pre></div>
</div>
</section>
<section id="retention-policies">
<h3>Retention Policies<a class="headerlink" href="#retention-policies" title="Link to this heading">¶</a></h3>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Backup Type</p></th>
<th class="head"><p>Frequency</p></th>
<th class="head"><p>Retention</p></th>
<th class="head"><p>Storage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Longhorn snapshots</p></td>
<td><p>Daily</p></td>
<td><p>7 days</p></td>
<td><p>Local (Longhorn)</p></td>
</tr>
<tr class="row-odd"><td><p>Database dumps</p></td>
<td><p>Daily</p></td>
<td><p>30 days</p></td>
<td><p>PVC + S3</p></td>
</tr>
<tr class="row-even"><td><p>Longhorn backups</p></td>
<td><p>Weekly</p></td>
<td><p>90 days</p></td>
<td><p>S3 (same region)</p></td>
</tr>
<tr class="row-odd"><td><p>Velero backups</p></td>
<td><p>Daily</p></td>
<td><p>30 days</p></td>
<td><p>S3 (same region)</p></td>
</tr>
<tr class="row-even"><td><p>Long-term archives</p></td>
<td><p>Monthly</p></td>
<td><p>1 year</p></td>
<td><p>S3 (cross-region)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="backup-monitoring">
<h2>Backup Monitoring<a class="headerlink" href="#backup-monitoring" title="Link to this heading">¶</a></h2>
<p>Set up alerts for backup failures:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span data-line="2"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span data-line="3"><span class="nt">metadata</span><span class="p">:</span>
</span><span data-line="4"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backup-monitoring</span>
</span><span data-line="5"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
</span><span data-line="6"><span class="nt">data</span><span class="p">:</span>
</span><span data-line="7"><span class="w">  </span><span class="nt">alerts.yaml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span data-line="8"><span class="w">    </span><span class="no">groups:</span>
</span><span data-line="9"><span class="w">    </span><span class="no">- name: mailu-backups</span>
</span><span data-line="10"><span class="w">      </span><span class="no">rules:</span>
</span><span data-line="11"><span class="w">      </span><span class="no">- alert: MailuBackupFailed</span>
</span><span data-line="12"><span class="w">        </span><span class="no">expr: kube_job_status_failed{namespace=&quot;mailu&quot;, job_name=~&quot;mailu-db-backup-.*&quot;} &gt; 0</span>
</span><span data-line="13"><span class="w">        </span><span class="no">for: 10m</span>
</span><span data-line="14"><span class="w">        </span><span class="no">annotations:</span>
</span><span data-line="15"><span class="w">          </span><span class="no">summary: &quot;Mailu database backup failed&quot;</span>
</span><span data-line="16"><span class="w">          </span><span class="no">description: &quot;Backup job {{ $labels.job_name }} failed&quot;</span>
</span><span data-line="17">
</span><span data-line="18"><span class="w">      </span><span class="no">- alert: MailuNoRecentBackup</span>
</span><span data-line="19"><span class="w">        </span><span class="no">expr: time() - max(kube_job_completion_time{namespace=&quot;mailu&quot;, job_name=~&quot;mailu-db-backup-.*&quot;}) &gt; 86400</span>
</span><span data-line="20"><span class="w">        </span><span class="no">annotations:</span>
</span><span data-line="21"><span class="w">          </span><span class="no">summary: &quot;No Mailu backup in 24 hours&quot;</span>
</span></pre></div>
</div>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="upgrade-mailu.html"><span class="std std-doc">Upgrade Mailu</span></a> - Always backup before upgrading</p></li>
<li><p><a class="reference internal" href="../reference/component-specifications.html"><span class="std std-doc">Component Specifications</span></a> - Storage requirements</p></li>
<li><p><a class="reference external" href="https://longhorn.io/docs/">Longhorn Documentation</a> - Volume snapshots and backups</p></li>
<li><p><a class="reference external" href="https://velero.io/docs/">Velero Documentation</a> - Cluster-level backups</p></li>
<li><p><a class="reference external" href="https://cloudnative-pg.io/documentation/">CloudNativePG Documentation</a> - PostgreSQL backups</p></li>
</ul>
</section>
</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="upgrade-mailu.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">Upgrade Mailu Version</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="../reference/index.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Reference</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024-2025, Blue Dynamics Alliance</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=7026087e"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=c1cf1a6b"></script>
      <script src="../_static/logo-fix.js?v=f9d4972b"></script>
      <script src="../_static/logo-text.js"></script></body>
</html>