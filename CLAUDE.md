# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is `cdk8s-mailu`, a CDK8S construct library for deploying Mailu mail server to Kubernetes. It provides type-safe, production-grade Kubernetes manifest generation from TypeScript code.

**Key Characteristics**:
- Built with Projen (project generator/manager)
- Uses CDK8S constructs pattern (similar to AWS CDK)
- Targets Kubernetes 1.28+ with cdk8s-plus-33
- Exports as npm library for use in other projects

## Development Commands

All commands use Projen task runner (via `npm run` or `npx projen`):

```bash
# Full build pipeline (compile + test + synth)
npm run build

# Compile TypeScript only
npm run compile

# Run tests with coverage (>96% target)
npm test

# Watch mode for tests
npm run test:watch

# Generate manifests from example
npm run synth:example

# Lint code
npm run eslint

# Update K8S API imports (after K8S version upgrade)
npm run import

# Upgrade dependencies (projen + cdk8s)
npm run upgrade
```

**Testing Specific Components**:
```bash
# Run single test file
npx jest test/mailu-chart.test.ts

# Run tests matching pattern
npx jest --testNamePattern="validation"

# Run with verbose output
npx jest --verbose
```

**Projen Management**:
- **NEVER edit `package.json`, `tsconfig.json`, `.gitignore` directly** - they are generated
- Edit `.projenrc.ts` instead, then run `npm run projen` to regenerate
- See [.projenrc.ts](.projenrc.ts) for project configuration

## Architecture and Structure

### CDK8S Construct Pattern

The project follows the CDK8S construct hierarchy:

```
MailuChart (extends Chart)
├── Creates namespace, shared ConfigMap, patch ConfigMaps
└── Instantiates component constructs:
    ├── AdminConstruct (web UI)
    ├── FrontConstruct (nginx proxy)
    ├── PostfixConstruct (SMTP)
    ├── DovecotConstruct (IMAP/POP3)
    ├── DovecotSubmissionConstruct (webmail token auth)
    ├── RspamdConstruct (spam filter)
    └── Optional: WebmailConstruct, ClamavConstruct, FetchmailConstruct, WebdavConstruct
```

**Key Pattern**: Each construct is self-contained:
- Accepts `MailuChartConfig` + namespace + shared resources
- Creates Deployment/StatefulSet + Service + PVC (if needed)
- Returns public `deployment` and `service` properties for cross-references
- Follows `src/constructs/<component>-construct.ts` naming

### Configuration Architecture

**Type-Safe Configuration** ([src/config.ts](src/config.ts)):
- `MailuChartConfig` is the single source of truth
- No inline secrets (only secret references: `secretName` + `secretKey`)
- Nested interfaces for database, redis, storage, components, resources
- TypeScript interfaces enforce compile-time validation

**Validation Strategy**:
- Runtime validation for critical values (domain format, CIDR format)
- Validators in [src/utils/validators.ts](src/utils/validators.ts)
- Validation errors thrown in `MailuChart` constructor before any resources created

### Service Discovery Pattern

**Two-Phase Initialization**:
1. Components create Deployments/Services with dynamic names
2. `updateConfigMapWithServiceDiscovery()` adds service addresses to shared ConfigMap

**Why**: Service names are generated by CDK8S (`this.deployment.name`), so we can't know them until after instantiation.

**Example**:
```typescript
// Phase 1: Create components
this.adminConstruct = new AdminConstruct(this, 'admin', { ... });

// Phase 2: Update ConfigMap with generated service names
this.sharedConfigMap.addData('ADMIN_ADDRESS',
  `${this.adminConstruct.service.name}.${namespace}.svc.cluster.local`);
```

### Dovecot Submission Service

**Critical Design**: Webmail email sending uses a dedicated Dovecot submission service (not the main Dovecot IMAP service) to enable token-based authentication without password entry.

**Architecture**:
- Webmail → Dovecot Submission (port 587, token auth) → Postfix (port 25, relay)
- `DovecotSubmissionConstruct` creates a separate StatefulSet
- Webmail environment variable `SUBMISSION_ADDRESS` points to this service
- See [documentation/sources/explanation/dovecot-submission.md](documentation/sources/explanation/dovecot-submission.md) for details

## Testing Strategy

**Test Structure** ([test/](test/)):
- One test file per construct: `<component>-construct.test.ts`
- Chart-level tests: `mailu-chart.test.ts`
- Utility tests: `validators.test.ts`, `resource-parser.test.ts`

**Testing Pattern** (using CDK8S Testing utilities):
```typescript
import { Testing } from 'cdk8s';
import { MailuChart } from '../src/mailu-chart';

const app = Testing.app();
const chart = new MailuChart(app, 'test', validConfig);
const manifests = Testing.synth(chart);

// Check for expected resources
expect(manifests).toHaveLength(expectedCount);
expect(manifests).toContainEqual(
  expect.objectContaining({
    kind: 'Deployment',
    metadata: expect.objectContaining({ name: 'test-admin' }),
  })
);
```

**Key Test Patterns**:
- Validation tests: Ensure bad config throws with clear error messages
- Manifest synthesis tests: Verify correct Kubernetes resources generated
- Component toggle tests: Ensure optional components only appear when enabled
- Cross-reference tests: Verify service discovery addresses are correct

## Documentation Structure

Follows [Diátaxis framework](https://diataxis.fr/) in [documentation/sources/](documentation/sources/):

- **[tutorials/](documentation/sources/tutorials/)** - Learning-oriented (step-by-step deployment)
- **[how-to/](documentation/sources/how-to/)** - Problem-oriented (specific tasks)
- **[explanation/](documentation/sources/explanation/)** - Understanding-oriented (architecture, decisions)
- **[reference/](documentation/sources/reference/)** - Information-oriented (API, configuration)

**Building Documentation**:
```bash
cd documentation
make docs          # Build HTML
make docs-live     # Live-reload dev server (http://localhost:8000)
make clean         # Clean generated files
```

**Important Files**:
- [documentation/sources/conf.py](documentation/sources/conf.py) - Sphinx configuration
- [documentation/sources/explanation/architecture.md](documentation/sources/explanation/architecture.md) - Component relationships
- [documentation/sources/explanation/dovecot-submission.md](documentation/sources/explanation/dovecot-submission.md) - Webmail email sending design

## Critical Implementation Details

### TLS Termination Strategy

**Configuration**: `TLS_FLAVOR=notls` with Traefik handling TLS termination

**Why**: Simplifies certificate management and follows Kubernetes best practices (ingress controller handles TLS)

**Implementation**:
- Web traffic: HTTP on port 80 (Traefik Ingress → HTTPS)
- Mail protocols: Wrapper script patches nginx config to add plaintext listeners on ports 465, 587, 993, 995
- Patch script: [src/constructs/nginx-patch-configmap.ts](src/constructs/nginx-patch-configmap.ts)
- Traefik IngressRouteTCP handles TLS for mail protocols

**CRITICAL**: The nginx patch is required because Mailu's TLS_FLAVOR=notls only supports web traffic on port 80. Mail protocol ports (465, 587, 993, 995) must be explicitly patched.

### Webmail Backend Connection

**Configuration**: Direct backend connections (`TLS_FLAVOR=notls`)

**Implementation**:
- Webmail connects directly to Dovecot IMAP and Dovecot Submission SMTP services
- Webmail wrapper script patches Roundcube config: [src/constructs/webmail-patch-configmap.ts](src/constructs/webmail-patch-configmap.ts)
- Bypasses front nginx proxy for email operations
- `WEB_WEBMAIL=/webmail` ensures browser AJAX requests use correct URL prefix

### Resource Parser Utilities

**Purpose**: Convert string resource values to CDK8S types

**Location**: [src/utils/resource-parser.ts](src/utils/resource-parser.ts)

**Functions**:
- `parseCpuMillis(cpu: string)`: "100m" → `kplus.Cpu.millis(100)`, "1" → `kplus.Cpu.millis(1000)`
- `parseMemorySize(memory: string)`: "256Mi" → `kplus.Size.mebibytes(256)`, "1Gi" → `kplus.Size.gibibytes(1)`

**Used in**: All construct resource configuration blocks

## Common Issues and Solutions

### Projen Regeneration

**Symptom**: Manual edits to `package.json` or `tsconfig.json` are lost after build

**Solution**: Edit [.projenrc.ts](.projenrc.ts) and run `npm run projen` to regenerate

### Import Errors After Kubernetes Upgrade

**Symptom**: CDK8S types don't match cluster Kubernetes version

**Solution**: Run `npm run import` to regenerate K8S API types from CRDs

### Test Failures on Component Toggle

**Symptom**: Tests fail when optional component is disabled but manifests still generated

**Cause**: Missing conditional in `MailuChart` component creation logic

**Fix Pattern**:
```typescript
if (config.components?.webmail) {
  this.createWebmailComponent();
}
```

### Service Discovery Address Incorrect

**Symptom**: Pods can't reach other components via service discovery

**Cause**: `updateConfigMapWithServiceDiscovery()` not called or service name incorrect

**Fix**: Ensure full DNS name format: `${service.name}.${namespace}.svc.cluster.local`

## Build System (Projen)

**What is Projen**: Project generator that manages configuration files as code

**Key Files**:
- [.projenrc.ts](.projenrc.ts) - Project definition (source of truth)
- `package.json`, `tsconfig.json`, `.eslintrc.json` - **Generated** (do not edit directly)

**Projen Workflow**:
1. Edit `.projenrc.ts` to change project configuration
2. Run `npm run projen` to regenerate files
3. Commit both `.projenrc.ts` and generated files

**Custom Projen Configuration in This Project**:
- `sampleCode: false` - No auto-generated example code
- Custom `synth:example` task for example synthesis
- GitHub Actions workflows (build, PR lint, auto-upgrade)
- Package exports configured for library usage (`main`, `types` fields)

## Development Workflow

**Adding a New Component**:
1. Create `src/constructs/<component>-construct.ts` with construct class
2. Add interface to `ComponentsConfig` in [src/config.ts](src/config.ts)
3. Add creation method in `MailuChart` class ([src/mailu-chart.ts](src/mailu-chart.ts))
4. Add service discovery address in `updateConfigMapWithServiceDiscovery()`
5. Write tests in `test/<component>-construct.test.ts`
6. Update documentation in `documentation/sources/`

**Modifying Configuration Interface**:
1. Edit [src/config.ts](src/config.ts) to add/modify interface properties
2. Add validation if needed (runtime checks for critical values)
3. Update all construct props to accept new configuration
4. Add tests for new configuration options
5. Update documentation (especially [reference/configuration-options.md](documentation/sources/reference/configuration-options.md))

**Release Process** (automated via GitHub Actions):
1. Merge PR to main branch
2. GitHub Action runs build + tests
3. Auto-upgrade workflow checks for dependency updates weekly
4. Manual releases via npm publish (not yet automated)
